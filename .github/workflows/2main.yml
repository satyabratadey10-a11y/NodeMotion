name: Build NodeMotion Rescue V11

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # --- STEP 1: DOWNLOAD ENGINE (Same as V10) ---
      - name: Download Engine
        run: |
          rm -rf app/src/main/cpp/quickjs_engine
          git clone --depth 1 https://github.com/bellard/quickjs.git app/src/main/cpp/quickjs_engine

      # --- STEP 2: REWRITE UI FOR FILE IMPORTING ---
      - name: Force Rewrite All Files
        run: |
          # 1. Update Manifest (Add Storage Permissions)
          echo '<?xml version="1.0" encoding="utf-8"?>' > app/src/main/AndroidManifest.xml
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android" xmlns:tools="http://schemas.android.com/tools">' >> app/src/main/AndroidManifest.xml
          echo '    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>' >> app/src/main/AndroidManifest.xml
          echo '    <application android:label="NodeMotion" android:theme="@style/Theme.AppCompat.NoActionBar">' >> app/src/main/AndroidManifest.xml
          echo '        <activity android:name=".MainActivity" android:exported="true">' >> app/src/main/AndroidManifest.xml
          echo '            <intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '        </activity>' >> app/src/main/AndroidManifest.xml
          echo '    </application>' >> app/src/main/AndroidManifest.xml
          echo '</manifest>' >> app/src/main/AndroidManifest.xml

          # 2. Update MainActivity.java (ADD IMPORT BUTTON & LOGIC)
          echo 'package com.example.nodemotion;' > app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import androidx.appcompat.app.AppCompatActivity;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.os.Bundle;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.widget.*;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.view.Gravity;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.graphics.Color;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.content.Intent;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import android.net.Uri;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import androidx.activity.result.ActivityResultLauncher;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import androidx.activity.result.contract.ActivityResultContracts;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import java.io.*;' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo 'public class MainActivity extends AppCompatActivity {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    static { System.loadLibrary("nodemotion"); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private EditText codeInput;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private TextView statusView;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private String currentVideoPath = "";' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # File Picker Logic
          echo '    private final ActivityResultLauncher<String> selectVideo = registerForActivityResult(' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        new ActivityResultContracts.GetContent(), uri -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            if (uri != null) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                copyToCache(uri);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        });' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '    @Override protected void onCreate(Bundle savedInstanceState) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        super.onCreate(savedInstanceState);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        LinearLayout layout = new LinearLayout(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.setOrientation(LinearLayout.VERTICAL);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.setBackgroundColor(Color.parseColor("#121212"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.setPadding(40, 40, 40, 40);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '        TextView title = new TextView(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        title.setText("NodeMotion Studio");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        title.setTextColor(Color.CYAN);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        title.setTextSize(24);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.addView(title);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # IMPORT BUTTON
          echo '        Button importBtn = new Button(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        importBtn.setText("IMPORT VIDEO / IMAGE");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        importBtn.setBackgroundColor(Color.DKGRAY);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        importBtn.setTextColor(Color.WHITE);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        importBtn.setOnClickListener(v -> selectVideo.launch("video/*"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.addView(importBtn);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        codeInput = new EditText(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        codeInput.setHint("// JS Code Here...");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        codeInput.setTextColor(Color.GREEN);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        codeInput.setMinLines(5);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.addView(codeInput);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        Button runBtn = new Button(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        runBtn.setText("RUN SCRIPT");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        runBtn.setOnClickListener(v -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            String res = runScript(codeInput.getText().toString());' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            statusView.setText("Result: " + res);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.addView(runBtn);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        statusView = new TextView(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        statusView.setText("No video loaded.");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        statusView.setTextColor(Color.LTGRAY);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        layout.addView(statusView);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '        setContentView(layout);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # Helper to copy video to internal cache so C++ can read it
          echo '    private void copyToCache(Uri uri) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        try {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            InputStream is = getContentResolver().openInputStream(uri);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            File file = new File(getCacheDir(), "temp_video.mp4");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            OutputStream os = new FileOutputStream(file);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            byte[] buffer = new byte[1024]; int len;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            while ((len = is.read(buffer)) > 0) os.write(buffer, 0, len);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            os.close(); is.close();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            currentVideoPath = file.getAbsolutePath();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            statusView.setText("Loaded: " + currentVideoPath);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        } catch (Exception e) { statusView.setText("Error: " + e.getMessage()); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '    public native String runScript(String scriptCode);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '}' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # 3. Rewrite Build Files (Same as V10 to keep it working)
          echo 'android.useAndroidX=true' > gradle.properties
          echo 'android.enableJetifier=true' >> gradle.properties
          echo 'android.suppressUnsupportedCompileSdk=34' >> gradle.properties
          
          echo 'cmake_minimum_required(VERSION 3.22.1)' > app/src/main/cpp/CMakeLists.txt
          echo 'project("nodemotion")' >> app/src/main/cpp/CMakeLists.txt
          echo 'set(QUICKJS_DIR ${CMAKE_CURRENT_SOURCE_DIR}/quickjs_engine)' >> app/src/main/cpp/CMakeLists.txt
          echo 'add_library(nodemotion SHARED native-lib.cpp ${QUICKJS_DIR}/quickjs.c ${QUICKJS_DIR}/libregexp.c ${QUICKJS_DIR}/cutils.c ${QUICKJS_DIR}/libunicode.c ${QUICKJS_DIR}/quickjs-libc.c ${QUICKJS_DIR}/dtoa.c)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_compile_definitions(nodemotion PRIVATE CONFIG_VERSION="2024-01-13")' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_compile_definitions(nodemotion PRIVATE _GNU_SOURCE)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_include_directories(nodemotion PRIVATE ${QUICKJS_DIR})' >> app/src/main/cpp/CMakeLists.txt
          echo 'find_library(log-lib log)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_link_libraries(nodemotion ${log-lib} m)' >> app/src/main/cpp/CMakeLists.txt

          echo '#include <jni.h>' > app/src/main/cpp/native-lib.cpp
          echo '#include <string>' >> app/src/main/cpp/native-lib.cpp
          echo '#include "quickjs_engine/quickjs.h"' >> app/src/main/cpp/native-lib.cpp
          echo 'extern "C" JNIEXPORT jstring JNICALL Java_com_example_nodemotion_MainActivity_runScript(JNIEnv* env, jobject, jstring scriptCode) { return env->NewStringUTF("JS Engine Ready"); }' >> app/src/main/cpp/native-lib.cpp

          echo 'pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }' > settings.gradle
          echo 'dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }' >> settings.gradle
          echo 'rootProject.name = "NodeMotion"' >> settings.gradle
          echo "include ':app'" >> settings.gradle
          echo 'plugins { id "com.android.application" version "8.1.0" apply false }' > build.gradle
          echo 'plugins { id "com.android.application" }' > app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.example.nodemotion"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.example.nodemotion"' >> app/build.gradle
          echo '        minSdk 21' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '        externalNativeBuild { cmake { cppFlags "-std=c++11"; arguments "-DANDROID_STL=c++_shared" } }' >> app/build.gradle
          echo '        ndk { abiFilters "armeabi-v7a", "arm64-v8a" }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt"; version "3.22.1" } }' >> app/build.gradle
          echo '    compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '    implementation "com.google.android.material:material:1.10.0"' >> app/build.gradle
          echo '}' >> app/build.gradle

      - name: Build with Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.2
          arguments: assembleDebug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NodeMotion-App-V11
          path: app/build/outputs/apk/debug/app-debug.apk
