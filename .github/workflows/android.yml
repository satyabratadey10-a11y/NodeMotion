name: Build NodeMotion Rescue

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download QuickJS
        run: |
          mkdir -p app/src/main/cpp/quickjs
          git clone https://github.com/bellard/quickjs.git app/src/main/cpp/quickjs

      # --- MAGICAL FIX SECTION ---
      # This step forcibly rewrites your build files to be perfect.
      # It fixes the version mismatch errors automatically.
      - name: Force Rewrite Build Files
        run: |
          # 1. Rewrite settings.gradle
          echo 'pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }' > settings.gradle
          echo 'dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }' >> settings.gradle
          echo 'rootProject.name = "NodeMotion"' >> settings.gradle
          echo "include ':app'" >> settings.gradle

          # 2. Rewrite Root build.gradle
          echo 'plugins { id "com.android.application" version "8.1.0" apply false }' > build.gradle
          echo 'task clean(type: Delete) { delete rootProject.buildDir }' >> build.gradle

          # 3. Rewrite App build.gradle
          echo 'plugins { id "com.android.application" }' > app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.example.nodemotion"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.example.nodemotion"' >> app/build.gradle
          echo '        minSdk 21' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '        externalNativeBuild { cmake { cppFlags "-std=c++11"; arguments "-DANDROID_STL=c++_shared" } }' >> app/build.gradle
          echo '        ndk { abiFilters "armeabi-v7a", "arm64-v8a" }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt"; version "3.22.1" } }' >> app/build.gradle
          echo '    compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }' >> app/build.gradle
          echo '}' >> app/build.gradle
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '    implementation "com.google.android.material:material:1.10.0"' >> app/build.gradle
          echo '}' >> app/build.gradle

      # --- BUILD SECTION ---
      # We use the official Gradle Action to force Version 8.2 (Stable)
      - name: Build with Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.2
          arguments: assembleDebug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NodeMotion-Rescue-APK
          path: app/build/outputs/apk/debug/app-debug.apk
