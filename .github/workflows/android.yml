name: Build NodeMotion Rescue V38 (Final Editor Fix)

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # --- STEP 1: DOWNLOAD JS ENGINE ---
      - name: Download JS Engine
        run: |
          rm -rf app/src/main/cpp/quickjs_engine
          git clone --depth 1 https://github.com/bellard/quickjs.git app/src/main/cpp/quickjs_engine

      # --- STEP 2: DOWNLOAD MOBILE-FFMPEG 4.4 ---
      - name: Download MobileFFmpeg 4.4
        run: |
          mkdir -p app/libs
          echo "Downloading MobileFFmpeg 4.4 LTS..."
          wget -O app/libs/ffmpeg.aar "https://artifactory.cronapp.io/libs-snapshot/com/arthenica/mobile-ffmpeg-full-gpl/4.4.LTS/mobile-ffmpeg-full-gpl-4.4.LTS.aar"

      # --- STEP 3: REWRITE APP FILES ---
      - name: Force Rewrite All Files
        run: |
          # 1. Update gradle.properties
          echo 'android.useAndroidX=true' > gradle.properties
          echo 'android.enableJetifier=true' >> gradle.properties
          echo 'android.suppressUnsupportedCompileSdk=34' >> gradle.properties

          # 2. Update settings.gradle
          echo 'pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }' > settings.gradle
          echo 'dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }' >> settings.gradle
          echo 'rootProject.name = "NodeMotion"' >> settings.gradle
          echo "include ':app'" >> settings.gradle

          # 3. Update app/build.gradle
          echo 'plugins { id "com.android.application" }' > app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.example.nodemotion"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.example.nodemotion"' >> app/build.gradle
          echo '        minSdk 24' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '        externalNativeBuild { cmake { cppFlags "-std=c++11"; arguments "-DANDROID_STL=c++_shared" } }' >> app/build.gradle
          echo '        ndk { abiFilters "armeabi-v7a", "arm64-v8a" }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt"; version "3.22.1" } }' >> app/build.gradle
          echo '    compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }' >> app/build.gradle
          echo '}' >> app/build.gradle
          
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '    implementation "com.google.android.material:material:1.10.0"' >> app/build.gradle
          echo '    implementation files("libs/ffmpeg.aar")' >> app/build.gradle
          echo '}' >> app/build.gradle

          # 4. Standard C++ Setup
          echo 'cmake_minimum_required(VERSION 3.22.1)' > app/src/main/cpp/CMakeLists.txt
          echo 'project("nodemotion")' >> app/src/main/cpp/CMakeLists.txt
          echo 'set(QUICKJS_DIR ${CMAKE_CURRENT_SOURCE_DIR}/quickjs_engine)' >> app/src/main/cpp/CMakeLists.txt
          echo 'add_library(nodemotion SHARED native-lib.cpp ${QUICKJS_DIR}/quickjs.c ${QUICKJS_DIR}/libregexp.c ${QUICKJS_DIR}/cutils.c ${QUICKJS_DIR}/libunicode.c ${QUICKJS_DIR}/quickjs-libc.c ${QUICKJS_DIR}/dtoa.c)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_compile_definitions(nodemotion PRIVATE CONFIG_VERSION="2024-01-13" _GNU_SOURCE)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_include_directories(nodemotion PRIVATE ${QUICKJS_DIR})' >> app/src/main/cpp/CMakeLists.txt
          echo 'find_library(log-lib log)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_link_libraries(nodemotion ${log-lib} m)' >> app/src/main/cpp/CMakeLists.txt

          # 5. Manifest
          echo '<?xml version="1.0" encoding="utf-8"?><manifest xmlns:android="http://schemas.android.com/apk/res/android"><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/><application android:label="NodeMotion" android:theme="@style/Theme.AppCompat.NoActionBar" android:requestLegacyExternalStorage="true"><activity android:name=".MainActivity" android:exported="true"><intent-filter><action android:name="android.intent.action.MAIN"/><category android:name="android.intent.category.LAUNCHER"/></intent-filter></activity></application></manifest>' > app/src/main/AndroidManifest.xml

          # 6. Java Logic (SYNTAX HIGHLIGHTING + ERROR CHECK)
          echo 'package com.example.nodemotion;' > app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import androidx.appcompat.app.AppCompatActivity; import android.os.Bundle; import android.widget.*; import android.view.*; import android.graphics.*; import android.graphics.drawable.*; import android.net.Uri; import java.io.*; import android.content.*; import android.provider.MediaStore; import android.app.AlertDialog; import android.media.MediaMetadataRetriever; import java.util.regex.*; import android.animation.*; import android.view.animation.*; import android.text.*; import android.text.style.*;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import com.arthenica.mobileffmpeg.FFmpeg; import com.arthenica.mobileffmpeg.Config;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo 'public class MainActivity extends AppCompatActivity {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    static { System.loadLibrary("nodemotion"); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private FrameLayout rootLayout; private VideoView videoPreview; private TextView statusView;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private LinearLayout exportPanel; private View dimOverlay; private ProgressBar progressBar; private TextView progressText;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private EditText codeInput; private boolean isCodeVisible = false;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private String inputPath=""; private String selectedRes="Original", selectedFps="Original", selectedBit="Auto", ccPath="";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private long totalDuration = 0;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private final androidx.activity.result.ActivityResultLauncher<String> selectVideo = registerForActivityResult(new androidx.activity.result.contract.ActivityResultContracts.GetContent(), uri -> { if(uri!=null) copyToCache(uri, "in.mp4"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private final androidx.activity.result.ActivityResultLauncher<String> selectCC = registerForActivityResult(new androidx.activity.result.contract.ActivityResultContracts.GetContent(), uri -> { if(uri!=null) copyToCache(uri, "lut.cube"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    @Override protected void onCreate(Bundle savedInstanceState) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        super.onCreate(savedInstanceState);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        rootLayout = new FrameLayout(this); rootLayout.setBackgroundColor(Color.parseColor("#0F0F0F"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '        videoPreview = new VideoView(this); videoPreview.setOnErrorListener((mp, what, extra) -> { statusView.setText("Preview Unavailable"); return true; });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        FrameLayout.LayoutParams vpParams = new FrameLayout.LayoutParams(-1, 800); vpParams.gravity = Gravity.CENTER; videoPreview.setLayoutParams(vpParams); rootLayout.addView(videoPreview);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '        codeInput = new EditText(this); codeInput.setText("return \"-vf hue=s=0\"; // Comment"); codeInput.setBackgroundColor(Color.parseColor("#1E1E1E")); codeInput.setTextColor(Color.WHITE); codeInput.setTypeface(Typeface.MONOSPACE); codeInput.setPadding(30,30,30,30); codeInput.setVisibility(View.GONE);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        enableSyntaxHighlighting();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        FrameLayout.LayoutParams cp = new FrameLayout.LayoutParams(-1, 500); cp.gravity = Gravity.TOP; cp.topMargin = 150; codeInput.setLayoutParams(cp); rootLayout.addView(codeInput);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        LinearLayout mainUI = new LinearLayout(this); mainUI.setOrientation(1); mainUI.setGravity(Gravity.BOTTOM);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        statusView = new TextView(this); statusView.setText("Welcome"); statusView.setTextColor(Color.WHITE); statusView.setPadding(40, 20, 40, 20); statusView.setBackground(makeRoundDrawable("#333333", 50)); LinearLayout.LayoutParams stParams = new LinearLayout.LayoutParams(-2,-2); stParams.gravity = Gravity.CENTER; stParams.setMargins(0,50,0,0); statusView.setLayoutParams(stParams); rootLayout.addView(statusView);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '        LinearLayout controls = new LinearLayout(this); controls.setGravity(17); controls.setPadding(0,0,0,20);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        controls.addView(createRoundButton("â–¶", "#444444", v->videoPreview.start()));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        controls.addView(new View(this){{setLayoutParams(new LinearLayout.LayoutParams(20,1));}});' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        controls.addView(createRoundButton("II", "#444444", v->videoPreview.pause()));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        controls.addView(new View(this){{setLayoutParams(new LinearLayout.LayoutParams(20,1));}});' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        controls.addView(createRoundButton("ðŸ“ CODE", "#61AFEF", v->{ isCodeVisible=!isCodeVisible; codeInput.setVisibility(isCodeVisible?View.VISIBLE:View.GONE); }));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        mainUI.addView(controls);' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        LinearLayout dock = new LinearLayout(this); dock.setOrientation(0); dock.setGravity(17); dock.setPadding(40,40,40,60); dock.addView(createModernButton("ðŸ“‚ LOAD", "#333333", v->selectVideo.launch("video/*"))); dock.addView(new View(this){{setLayoutParams(new LinearLayout.LayoutParams(30,1));}}); dock.addView(createModernButton("âœ¨ EXPORT", "#00E5FF", v->toggleExportPanel(true))); mainUI.addView(dock); rootLayout.addView(mainUI);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        dimOverlay = new View(this); dimOverlay.setBackgroundColor(Color.parseColor("#CC000000")); dimOverlay.setAlpha(0); dimOverlay.setVisibility(View.GONE); dimOverlay.setOnClickListener(v->toggleExportPanel(false)); rootLayout.addView(dimOverlay);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        setupExportPanel(); setupProgressOverlay(); setContentView(rootLayout);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # FIXED: Using (char)34 for double quotes to avoid shell escaping errors
          echo '    private void enableSyntaxHighlighting() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        codeInput.addTextChangedListener(new TextWatcher() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            boolean editing = false;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            public void beforeTextChanged(CharSequence s, int start, int count, int after) {}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            public void onTextChanged(CharSequence s, int start, int before, int count) {}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            public void afterTextChanged(Editable s) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(editing) return; editing = true;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                clearSpans(s);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                highlight(s, "\\b(return|var|const|let|function|if|else)\\b", Color.parseColor("#C678DD"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                highlight(s, "\".*?\"", Color.parseColor("#98C379"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                highlight(s, "//.*", Color.parseColor("#7F848E"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                highlight(s, "-[a-zA-Z:]+", Color.parseColor("#61AFEF"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                highlight(s, "\\b\\d+\\b", Color.parseColor("#D19A66"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          # CRITICAL FIX: Using (char)34 instead of escaped quotes
          echo '                if(countChar(s.toString(), (char)34) % 2 != 0) codeInput.setError("Unclosed String"); else codeInput.setError(null);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                editing = false;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private int countChar(String s, char c) { int count=0; for(int i=0; i<s.length(); i++) if(s.charAt(i)==c) count++; return count; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void clearSpans(Editable s) { ForegroundColorSpan[] spans = s.getSpans(0, s.length(), ForegroundColorSpan.class); for(ForegroundColorSpan span : spans) s.removeSpan(span); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void highlight(Editable s, String pattern, int color) { Matcher m = Pattern.compile(pattern).matcher(s); while(m.find()) { s.setSpan(new ForegroundColorSpan(color), m.start(), m.end(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE); } }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '    private Button createModernButton(String text, String colorHex, View.OnClickListener click) { Button b = new Button(this); b.setText(text); b.setTextColor(Color.WHITE); b.setTypeface(Typeface.DEFAULT_BOLD); b.setBackground(makeRoundDrawable(colorHex, 30)); b.setOnClickListener(click); return b; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private Button createRoundButton(String text, String colorHex, View.OnClickListener click) { Button b = new Button(this); b.setText(text); b.setTextColor(Color.WHITE); b.setBackground(makeRoundDrawable(colorHex, 100)); b.setOnClickListener(click); b.setLayoutParams(new LinearLayout.LayoutParams(120, 120)); return b; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private Drawable makeRoundDrawable(String color, int radius) { GradientDrawable gd = new GradientDrawable(); gd.setColor(Color.parseColor(color)); gd.setCornerRadius(radius); return gd; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void setupExportPanel() { exportPanel = new LinearLayout(this); exportPanel.setOrientation(1); exportPanel.setBackground(makeRoundDrawable("#1E1E1E", 40)); exportPanel.setPadding(60,60,60,60); FrameLayout.LayoutParams params = new FrameLayout.LayoutParams(-1, -2); params.gravity = Gravity.BOTTOM; exportPanel.setLayoutParams(params); exportPanel.setTranslationY(1000); addSettingRow("Resolution", new String[]{"Original", "480p", "720p", "1080p", "4K"}, s->selectedRes=s); addSettingRow("FPS", new String[]{"Original", "30", "60"}, s->selectedFps=s); exportPanel.addView(createModernButton("ðŸŽ¨ Add LUT", "#333333", v->selectCC.launch("*/*"))); exportPanel.addView(new View(this){{setLayoutParams(new LinearLayout.LayoutParams(1,30));}}); exportPanel.addView(createModernButton("ðŸš€ START EXPORT", "#00E5FF", v->{toggleExportPanel(false); runExportProcess();})); rootLayout.addView(exportPanel); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void addSettingRow(String title, String[] opts, java.util.function.Consumer<String> callback) { TextView tv = new TextView(this); tv.setText(title); tv.setTextColor(Color.LTGRAY); exportPanel.addView(tv); Spinner sp = new Spinner(this); sp.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_spinner_dropdown_item, opts)); sp.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener(){ public void onItemSelected(AdapterView<?> p, View v, int i, long i2){callback.accept(opts[i]); ((TextView)v).setTextColor(Color.WHITE);} public void onNothingSelected(AdapterView<?> p){} }); exportPanel.addView(sp); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void setupProgressOverlay() { LinearLayout ol = new LinearLayout(this); ol.setOrientation(1); ol.setGravity(17); ol.setBackgroundColor(Color.BLACK); ol.setAlpha(0); ol.setVisibility(View.GONE); progressBar = new ProgressBar(this, null, android.R.attr.progressBarStyleHorizontal); progressBar.setLayoutParams(new LinearLayout.LayoutParams(600, 20)); progressBar.setMax(100); progressText = new TextView(this); progressText.setTextColor(Color.WHITE); progressText.setTextSize(18); progressText.setPadding(0,40,0,0); ol.addView(progressBar); ol.addView(progressText); rootLayout.addView(ol); progressText.setTag(ol); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void toggleExportPanel(boolean show) { if(show) { dimOverlay.setVisibility(View.VISIBLE); dimOverlay.animate().alpha(1f).setDuration(300); exportPanel.animate().translationY(0).setInterpolator(new DecelerateInterpolator()).setDuration(400); } else { dimOverlay.animate().alpha(0f).setDuration(300).withEndAction(()->dimOverlay.setVisibility(View.GONE)); exportPanel.animate().translationY(1000).setDuration(300); } }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '    private void runExportProcess() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        if(inputPath.isEmpty()){statusView.setText("Please Load Video"); return;}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        View ol = (View)progressText.getTag(); ol.setVisibility(View.VISIBLE); ol.animate().alpha(1f);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Config.enableLogCallback(m -> { if(m.getText().contains("time=")) { Matcher mat = Pattern.compile("time=([\\d:.]+)").matcher(m.getText()); if(mat.find()) { String[] p=mat.group(1).split(":"); double s=Double.parseDouble(p[0])*3600+Double.parseDouble(p[1])*60+Double.parseDouble(p[2]); int pr=(int)((s*1000/totalDuration)*100); runOnUiThread(()->{progressBar.setProgress(pr); progressText.setText(pr+"%");}); } } });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        new Thread(() -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            try {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                String cmd = "-c:v h264_mediacodec -i " + inputPath;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                String code = codeInput.getText().toString().replace("return", "").replace(";", "").replace("\"", "").trim();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                String vf = "";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!selectedRes.equals("Original")) vf += "scale=-2:"+selectedRes.replace("p","");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!ccPath.isEmpty()) { if(!vf.isEmpty()) vf+=","; vf+="lut3d="+ccPath; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!code.isEmpty() && !code.equals("-vf hue=s=0")) { if(!vf.isEmpty()) vf+=","; vf+=code.replace("-vf ", ""); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!vf.isEmpty()) cmd += " -vf " + vf;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!selectedFps.equals("Original")) cmd += " -r " + selectedFps;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                cmd += " -preset ultrafast -c:a copy -y " + getCacheDir() + "/out.mp4";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(FFmpeg.execute(cmd)==Config.RETURN_CODE_SUCCESS){ saveToGallery(); runOnUiThread(()->{progressText.setText("DONE!"); ol.animate().alpha(0).setStartDelay(1000).withEndAction(()->ol.setVisibility(View.GONE));}); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            } catch(Exception e){}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        }).start();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private void saveToGallery() { try { File in=new File(getCacheDir(),"out.mp4"); ContentValues v=new ContentValues(); v.put(MediaStore.Video.Media.DISPLAY_NAME,"NM_"+System.currentTimeMillis()+".mp4"); v.put(MediaStore.Video.Media.MIME_TYPE,"video/mp4"); v.put(MediaStore.Video.Media.RELATIVE_PATH,"Movies/NodeMotion"); OutputStream o=getContentResolver().openOutputStream(getContentResolver().insert(MediaStore.Video.Media.EXTERNAL_CONTENT_URI,v)); java.nio.file.Files.copy(in.toPath(),o); o.close(); runOnUiThread(()->statusView.setText("Saved to Gallery")); } catch(Exception e){} }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private void copyToCache(Uri u, String n) { try { InputStream i=getContentResolver().openInputStream(u); File f=new File(getCacheDir(),n); java.nio.file.Files.copy(i, f.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING); if(n.equals("in.mp4")){inputPath=f.getAbsolutePath(); videoPreview.setVideoPath(inputPath); videoPreview.start(); MediaMetadataRetriever r=new MediaMetadataRetriever(); r.setDataSource(inputPath); totalDuration=Long.parseLong(r.extractMetadata(9));} else ccPath=f.getAbsolutePath(); } catch(Exception e){} }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    public native String runScript(String s);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '}' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # Native Glue
          echo '#include <jni.h>' > app/src/main/cpp/native-lib.cpp
          echo '#include <string>' >> app/src/main/cpp/native-lib.cpp
          echo 'extern "C" JNIEXPORT jstring JNICALL Java_com_example_nodemotion_MainActivity_runScript(JNIEnv* env, jobject, jstring s) { return env->NewStringUTF(""); }' >> app/src/main/cpp/native-lib.cpp

      - name: Build with Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.2
          arguments: assembleDebug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NodeMotion-V38-FinalEditor
          path: app/build/outputs/apk/debug/app-debug.apk
