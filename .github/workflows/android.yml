name: Build NodeMotion Rescue V32 (Smart Progress)

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      # --- STEP 1: DOWNLOAD JS ENGINE ---
      - name: Download JS Engine
        run: |
          rm -rf app/src/main/cpp/quickjs_engine
          git clone --depth 1 https://github.com/bellard/quickjs.git app/src/main/cpp/quickjs_engine

      # --- STEP 2: DOWNLOAD MOBILE-FFMPEG 4.4 ---
      - name: Download MobileFFmpeg 4.4
        run: |
          mkdir -p app/libs
          echo "Downloading MobileFFmpeg 4.4 LTS..."
          wget -O app/libs/ffmpeg.aar "https://artifactory.cronapp.io/libs-snapshot/com/arthenica/mobile-ffmpeg-full-gpl/4.4.LTS/mobile-ffmpeg-full-gpl-4.4.LTS.aar"

      # --- STEP 3: REWRITE APP FILES ---
      - name: Force Rewrite All Files
        run: |
          # 1. Update gradle.properties
          echo 'android.useAndroidX=true' > gradle.properties
          echo 'android.enableJetifier=true' >> gradle.properties
          echo 'android.suppressUnsupportedCompileSdk=34' >> gradle.properties

          # 2. Update settings.gradle
          echo 'pluginManagement { repositories { google(); mavenCentral(); gradlePluginPortal() } }' > settings.gradle
          echo 'dependencyResolutionManagement { repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS); repositories { google(); mavenCentral() } }' >> settings.gradle
          echo 'rootProject.name = "NodeMotion"' >> settings.gradle
          echo "include ':app'" >> settings.gradle

          # 3. Update app/build.gradle
          echo 'plugins { id "com.android.application" }' > app/build.gradle
          echo 'android {' >> app/build.gradle
          echo '    namespace "com.example.nodemotion"' >> app/build.gradle
          echo '    compileSdk 34' >> app/build.gradle
          echo '    defaultConfig {' >> app/build.gradle
          echo '        applicationId "com.example.nodemotion"' >> app/build.gradle
          echo '        minSdk 24' >> app/build.gradle
          echo '        targetSdk 34' >> app/build.gradle
          echo '        versionCode 1' >> app/build.gradle
          echo '        versionName "1.0"' >> app/build.gradle
          echo '        externalNativeBuild { cmake { cppFlags "-std=c++11"; arguments "-DANDROID_STL=c++_shared" } }' >> app/build.gradle
          echo '        ndk { abiFilters "armeabi-v7a", "arm64-v8a" }' >> app/build.gradle
          echo '    }' >> app/build.gradle
          echo '    externalNativeBuild { cmake { path "src/main/cpp/CMakeLists.txt"; version "3.22.1" } }' >> app/build.gradle
          echo '    compileOptions { sourceCompatibility JavaVersion.VERSION_1_8; targetCompatibility JavaVersion.VERSION_1_8 }' >> app/build.gradle
          echo '}' >> app/build.gradle
          
          echo 'dependencies {' >> app/build.gradle
          echo '    implementation "androidx.appcompat:appcompat:1.6.1"' >> app/build.gradle
          echo '    implementation "com.google.android.material:material:1.10.0"' >> app/build.gradle
          echo '    implementation files("libs/ffmpeg.aar")' >> app/build.gradle
          echo '}' >> app/build.gradle

          # 4. Standard C++ Setup
          echo 'cmake_minimum_required(VERSION 3.22.1)' > app/src/main/cpp/CMakeLists.txt
          echo 'project("nodemotion")' >> app/src/main/cpp/CMakeLists.txt
          echo 'set(QUICKJS_DIR ${CMAKE_CURRENT_SOURCE_DIR}/quickjs_engine)' >> app/src/main/cpp/CMakeLists.txt
          echo 'add_library(nodemotion SHARED native-lib.cpp ${QUICKJS_DIR}/quickjs.c ${QUICKJS_DIR}/libregexp.c ${QUICKJS_DIR}/cutils.c ${QUICKJS_DIR}/libunicode.c ${QUICKJS_DIR}/quickjs-libc.c ${QUICKJS_DIR}/dtoa.c)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_compile_definitions(nodemotion PRIVATE CONFIG_VERSION="2024-01-13" _GNU_SOURCE)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_include_directories(nodemotion PRIVATE ${QUICKJS_DIR})' >> app/src/main/cpp/CMakeLists.txt
          echo 'find_library(log-lib log)' >> app/src/main/cpp/CMakeLists.txt
          echo 'target_link_libraries(nodemotion ${log-lib} m)' >> app/src/main/cpp/CMakeLists.txt

          # 5. Manifest
          echo '<?xml version="1.0" encoding="utf-8"?><manifest xmlns:android="http://schemas.android.com/apk/res/android"><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/><uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/><application android:label="NodeMotion" android:theme="@style/Theme.AppCompat.NoActionBar" android:requestLegacyExternalStorage="true"><activity android:name=".MainActivity" android:exported="true"><intent-filter><action android:name="android.intent.action.MAIN"/><category android:name="android.intent.category.LAUNCHER"/></intent-filter></activity></application></manifest>' > app/src/main/AndroidManifest.xml

          # 6. Java Logic (SMART PROGRESS BAR)
          echo 'package com.example.nodemotion;' > app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import androidx.appcompat.app.AppCompatActivity; import android.os.Bundle; import android.widget.*; import android.view.*; import android.graphics.Color; import android.net.Uri; import java.io.*; import android.content.*; import android.provider.MediaStore; import android.app.AlertDialog; import android.media.MediaMetadataRetriever; import java.util.regex.*;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo 'import com.arthenica.mobileffmpeg.FFmpeg; import com.arthenica.mobileffmpeg.Config;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo 'public class MainActivity extends AppCompatActivity {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    static { System.loadLibrary("nodemotion"); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private VideoView videoPreview; private TextView statusView; private String inputPath="";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private String selectedRes = "Original"; private String selectedFps = "Original"; private String selectedBit = "Auto"; private String ccPath = "";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private AlertDialog progressDialog; private ProgressBar progressBar; private TextView progressText;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private long totalDuration = 0;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private final androidx.activity.result.ActivityResultLauncher<String> selectVideo = registerForActivityResult(new androidx.activity.result.contract.ActivityResultContracts.GetContent(), uri -> { if(uri!=null) copyToCache(uri, "in.mp4"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    private final androidx.activity.result.ActivityResultLauncher<String> selectCC = registerForActivityResult(new androidx.activity.result.contract.ActivityResultContracts.GetContent(), uri -> { if(uri!=null) copyToCache(uri, "lut.cube"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    @Override protected void onCreate(Bundle savedInstanceState) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        super.onCreate(savedInstanceState);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        LinearLayout main = new LinearLayout(this); main.setOrientation(1); main.setBackgroundColor(Color.parseColor("#101010"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          # PREVIEW SCREEN
          echo '        videoPreview = new VideoView(this);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        LinearLayout.LayoutParams vp = new LinearLayout.LayoutParams(-1, 800); videoPreview.setLayoutParams(vp); main.addView(videoPreview);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          # CONTROLS
          echo '        LinearLayout ctl = new LinearLayout(this); ctl.setGravity(17); ctl.setPadding(0,20,0,20);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Button b1 = new Button(this); b1.setText("ðŸ“‚ LOAD"); b1.setOnClickListener(v->selectVideo.launch("video/*"));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Button b2 = new Button(this); b2.setText("âš™ EXPORT"); b2.setBackgroundColor(Color.CYAN); b2.setTextColor(Color.BLACK); b2.setOnClickListener(v->showExportSettings());' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        ctl.addView(b1); ctl.addView(b2); main.addView(ctl);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          # STATUS
          echo '        statusView = new TextView(this); statusView.setText("Ready"); statusView.setTextColor(Color.DKGRAY); statusView.setGravity(17); main.addView(statusView);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        setContentView(main);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # EXPORT SETTINGS
          echo '    private void showExportSettings() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        AlertDialog.Builder b = new AlertDialog.Builder(this); b.setTitle("Export Settings");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        LinearLayout l = new LinearLayout(this); l.setOrientation(1); l.setPadding(50,20,50,20);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        l.addView(new TextView(this){{setText("Resolution:");}});' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Spinner spRes = new Spinner(this); spRes.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_spinner_dropdown_item, new String[]{"Original", "480p", "720p", "1080p", "1440p", "2160p"}));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        l.addView(spRes);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        l.addView(new TextView(this){{setText("FPS:");}});' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Spinner spFps = new Spinner(this); spFps.setAdapter(new ArrayAdapter<>(this, android.R.layout.simple_spinner_dropdown_item, new String[]{"Original", "24", "30", "60", "90"}));' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        l.addView(spFps);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        Button btnCC = new Button(this); btnCC.setText("ðŸŽ¨ Load Custom CC"); btnCC.setOnClickListener(v->selectCC.launch("*/*")); l.addView(btnCC);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        b.setView(l);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        b.setNegativeButton("CANCEL", (d,w) -> d.dismiss());' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        b.setPositiveButton("EXPORT", (d,w) -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            selectedRes=spRes.getSelectedItem().toString(); selectedFps=spFps.getSelectedItem().toString();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            runExportProcess();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        }); b.show();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # PROGRESS WINDOW
          echo '    private void showProgressWindow() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        AlertDialog.Builder b = new AlertDialog.Builder(this); b.setCancelable(false);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        LinearLayout l = new LinearLayout(this); l.setOrientation(1); l.setPadding(60,60,60,60); l.setGravity(17);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        progressBar = new ProgressBar(this, null, android.R.attr.progressBarStyleHorizontal); progressBar.setMax(100); progressBar.setLayoutParams(new LinearLayout.LayoutParams(-1, 50)); l.addView(progressBar);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        progressText = new TextView(this); progressText.setText("Starting..."); progressText.setTextSize(16); progressText.setPadding(0,30,0,0); l.addView(progressText);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        b.setView(l); progressDialog = b.create(); progressDialog.show();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # EXPORT + LOGIC TO READ PROGRESS
          echo '    private void runExportProcess() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        if(inputPath.isEmpty()){Toast.makeText(this,"Load Video First!",Toast.LENGTH_SHORT).show();return;}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        showProgressWindow();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          # Enable Logs to catch "time=00:00:05"
          echo '        Config.enableLogCallback(message -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            String text = message.getText();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            if(text.contains("time=")) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                try {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    Matcher m = Pattern.compile("time=([\\d:.]+)").matcher(text);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    if(m.find()) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                        String t = m.group(1);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                        String[] parts = t.split(":");' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                        double seconds = Double.parseDouble(parts[0])*3600 + Double.parseDouble(parts[1])*60 + Double.parseDouble(parts[2]);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                        int prog = (int)((seconds * 1000 / totalDuration) * 100);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                        runOnUiThread(() -> { progressBar.setProgress(prog); progressText.setText("Exporting: " + t + " (" + prog + "%)"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                } catch(Exception e){}' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        });' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          echo '        new Thread(() -> {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            try {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                String vf = "";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!selectedRes.equals("Original")) { String h=selectedRes.replace("p",""); vf+="scale=-2:"+h; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!ccPath.isEmpty()) { if(!vf.isEmpty()) vf+=","; vf+="lut3d="+ccPath; }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                String cmd = "-i "+inputPath;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!vf.isEmpty()) cmd+=" -vf "+vf;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(!selectedFps.equals("Original")) cmd+=" -r "+selectedFps;' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                cmd+=" -c:a copy -y "+getCacheDir()+"/out.mp4";' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '                int rc = FFmpeg.execute(cmd);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                if(rc == Config.RETURN_CODE_SUCCESS) {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    saveToGallery();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    runOnUiThread(() -> { progressBar.setProgress(100); progressText.setText("Successfully Exported!"); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    Thread.sleep(1500);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    runOnUiThread(() -> progressDialog.dismiss());' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                } else {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                    runOnUiThread(() -> { progressText.setText("Failed: " + rc); progressDialog.setCancelable(true); });' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '                }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '            } catch(Exception e) { runOnUiThread(() -> progressText.setText("Err: "+e.getMessage())); }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        }).start();' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private void saveToGallery() {' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '        try { File in = new File(getCacheDir(), "out.mp4"); ContentValues v = new ContentValues(); v.put(MediaStore.Video.Media.DISPLAY_NAME, "NM_"+System.currentTimeMillis()+".mp4"); v.put(MediaStore.Video.Media.MIME_TYPE, "video/mp4"); v.put(MediaStore.Video.Media.RELATIVE_PATH, "Movies/NodeMotion"); Uri u = getContentResolver().insert(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, v); OutputStream o = getContentResolver().openOutputStream(u); java.nio.file.Files.copy(in.toPath(), o); o.close(); } catch(Exception e) {} }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          
          echo '    private void copyToCache(Uri uri, String name) { try { InputStream i=getContentResolver().openInputStream(uri); File f=new File(getCacheDir(),name); java.nio.file.Files.copy(i, f.toPath(), java.nio.file.StandardCopyOption.REPLACE_EXISTING); if(name.equals("in.mp4")){inputPath=f.getAbsolutePath(); videoPreview.setVideoPath(inputPath); videoPreview.start(); MediaMetadataRetriever r = new MediaMetadataRetriever(); r.setDataSource(inputPath); totalDuration = Long.parseLong(r.extractMetadata(MediaMetadataRetriever.METADATA_KEY_DURATION)); } else {ccPath=f.getAbsolutePath(); statusView.setText("CC Loaded");} } catch(Exception e){} }' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '    public native String runScript(String s);' >> app/src/main/java/com/example/nodemotion/MainActivity.java
          echo '}' >> app/src/main/java/com/example/nodemotion/MainActivity.java

          # Native Glue
          echo '#include <jni.h>' > app/src/main/cpp/native-lib.cpp
          echo '#include <string>' >> app/src/main/cpp/native-lib.cpp
          echo 'extern "C" JNIEXPORT jstring JNICALL Java_com_example_nodemotion_MainActivity_runScript(JNIEnv* env, jobject, jstring s) { return env->NewStringUTF(""); }' >> app/src/main/cpp/native-lib.cpp

      - name: Build with Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.2
          arguments: assembleDebug
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: NodeMotion-V32-SmartProgress
          path: app/build/outputs/apk/debug/app-debug.apk
